<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Photonik Racer Online</title>
    
    <!-- Carga Socket.IO desde el servidor -->
    <script src="/socket.io/socket.io.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: 'Segoe UI', sans-serif; user-select: none; }

        /* DEBUG CONSOLE */
        #debug-console-container {
            position: absolute; top: 10px; left: 10px; width: 300px;
            background: rgba(0,0,0,0.8); border: 1px solid #444; z-index: 1000;
            font-family: monospace; font-size: 11px;
            pointer-events: none; /* Dejar pasar clics si no se interact√∫a */
        }
        #console-header { background: #222; padding: 5px; color: #8f8; cursor: pointer; display: flex; justify-content: space-between; pointer-events: auto; }
        #console-body { height: 150px; overflow-y: auto; padding: 5px; color: #ccc; pointer-events: auto; }
        
        /* START SCREEN */
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #050510 0%, #202030 100%); z-index: 500; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #intro-panel, #lobby-ui { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; max-width: 400px; transition: opacity 0.5s; }
        h1 { font-size: 3.5rem; margin: 0; background: -webkit-linear-gradient(#fff, #4488ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px; text-shadow: 0 0 30px rgba(68,136,255,0.5); }
        
        .big-btn { padding: 15px 50px; font-size: 1.2rem; background: #ff3333; color: white; border: none; border-radius: 50px; cursor: pointer; transition: 0.2s; box-shadow: 0 0 20px #f006; font-weight: bold; letter-spacing: 1px; }
        .big-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px #f009; }
        .big-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .action-btn { padding: 15px 30px; background: #3388ff; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; }
        .action-btn:hover { background: #4499ff; }
        
        .secondary-btn { padding: 10px 20px; background: #444; color: white; border: none; border-radius: 20px; cursor: pointer; margin-left: 10px; }
        .code-input { padding: 12px; background: #222; border: 1px solid #555; color: white; text-align: center; border-radius: 10px; flex-grow: 1; font-size: 1rem; text-transform: uppercase; }
        .separator { width: 100%; height: 1px; background: linear-gradient(90deg, transparent, #555, transparent); margin: 20px 0; }
        .panel-section { width: 100%; display: flex; }

        /* ROOM LIST */
        #room-list-container { width: 100%; min-height: 100px; max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.4); border-radius: 10px; border: 1px solid #333; margin-top: 10px; }
        .room-item { padding: 12px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .room-item:hover { background: rgba(255,255,255,0.05); }
        .room-item button { padding: 5px 15px; background: #38f; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; }
        .room-info { display: flex; flex-direction: column; }
        .room-code { font-family: monospace; font-size: 1.2em; color: #fb3; }
        .room-details { font-size: 0.8em; color: #aaa; }

        /* HUD & GAME UI */
        #ui-layer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #menu-btn { position: absolute; top: 20px; right: 20px; font-size: 30px; cursor: pointer; pointer-events: auto; filter: drop-shadow(0 0 5px black); }
        #menu-modal { display: none; position: absolute; top: 60px; right: 20px; width: 250px; background: rgba(20,20,30,0.95); padding: 15px; border-radius: 10px; flex-direction: column; gap: 10px; pointer-events: auto; border: 1px solid #444; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .title-sep { color: #888; font-size: 10px; border-bottom: 1px solid #444; margin-top: 5px; padding-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }

        /* CONTROLS */
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px; border: 2px solid rgba(255,255,255,0.15); border-radius: 50%; pointer-events: auto; touch-action: none; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,50,50,0.8); border-radius: 50%; transform: translate(-50%,-50%); box-shadow: 0 0 10px #f00; }
        .pedal { position: absolute; bottom: 40px; width: 80px; height: 160px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 30px; pointer-events: auto; cursor: pointer; user-select: none; touch-action: none; transition: transform 0.1s; }
        .pedal:active { transform: scale(0.95); opacity: 0.8; }
        #gas-btn { right: 40px; background: linear-gradient(to top, #600, #d00); }
        #brake-btn { right: 140px; height: 100px; bottom: 40px; background: linear-gradient(to top, #222, #555); }
        
        #hud-speed { position: absolute; bottom: 220px; right: 40px; text-align: right; text-shadow: 0 0 10px #000; }
        #speed-val { font-size: 80px; font-weight: bold; color: #fff; font-family: 'Courier New', monospace; font-style: italic; }
        small { color: #aaa; font-size: 20px; font-weight: bold; }

        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; gap: 20px; }
        .loader { width: 50px; height: 50px; border: 5px solid #333; border-top-color: #38f; border-radius: 50%; animation: rot 1s linear infinite; }
        @keyframes rot { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- CONSOLA DEBUG -->
<div id="debug-console-container">
    <div id="console-header">SYSTEM LOG <span id="toggle-console">_</span></div>
    <div id="console-body"></div>
</div>

<!-- LOBBY & MENU -->
<div id="start-screen">
    <div id="intro-panel">
        <h1>PHOTONIK</h1>
        <p style="color:#88f; letter-spacing:4px;">ONLINE MULTIPLAYER</p>
        <br>
        <button id="btn-connect" class="big-btn">CONECTAR A SERVIDOR</button>
        <div id="connection-status" style="margin-top:15px; color:#666; font-size:12px; font-family:monospace;">Estado: Esperando acci√≥n...</div>
    </div>

    <!-- Panel Lobby -->
    <div id="lobby-ui" style="display:none;">
        <h2 style="color:white;">SALA DE ESPERA</h2>
        
        <div class="panel-section">
            <button id="btn-create-room" class="action-btn">‚ú® CREAR NUEVA PARTIDA</button>
        </div>

        <div class="separator"></div>

        <div class="panel-section">
            <input type="text" id="room-code-input" placeholder="C√ìDIGO..." class="code-input">
            <button id="btn-join-code" class="secondary-btn">ENTRAR</button>
            <button id="btn-refresh" class="secondary-btn">‚Üª</button>
        </div>

        <div id="room-list-container">
            <div style="padding:20px; text-align:center; color:#888;">Pulsa refrescar para buscar partidas...</div>
        </div>
    </div>
</div>

<!-- CARGA -->
<div id="loading">
    <span class="loader"></span>
    <div style="color:#fff; font-family:monospace;">GENERANDO MUNDO PROCEDURAL...</div>
</div>

<!-- HUD -->
<div id="ui-layer">
    <div id="hud-speed"><span id="speed-val">0</span><small> KM/H</small></div>
    
    <div id="manual-controls">
        <div id="joystick-zone"><div id="joystick-knob"></div></div>
        <div id="brake-btn" class="pedal">üõë</div>
        <div id="gas-btn" class="pedal">üöÄ</div>
    </div>
    
    <div id="menu-btn">‚öôÔ∏è</div>
    
    <!-- Modal Configuraci√≥n -->
    <div id="menu-modal">
        <div class="title-sep">ESTAD√çSTICAS SALA</div>
        <div class="menu-item"><span>L√≠mite Vel.</span><span id="disp-max" class="val-display">--</span></div>
        <div class="menu-item"><span>Aceleraci√≥n</span><span id="disp-acc" class="val-display">--</span></div>
        
        <div class="title-sep">MIS CONTROLES</div>
        <div class="menu-item"><span>Invertir Giro</span><input type="checkbox" id="chk-invert"></div>
        <div class="menu-item"><span>Mostrar Freno</span><input type="checkbox" id="chk-brake" checked></div>
        
        <div class="title-sep">CONFIG PARTIDA (ADMIN)</div>
        <div class="menu-item"><span>Max Speed</span><input type="range" id="cfg-max" min="200" max="800" value="500" style="width:80px"></div>
        <div class="menu-item"><span>Accel</span><input type="range" id="cfg-acc" min="20" max="80" value="40" style="width:80px"></div>
    </div>
</div>

<!-- L√ìGICA PRINCIPAL DEL JUEGO -->
<script type="module">
    // Importamos Three.js desde CDN (M√≥dulos modernos)
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { EffectComposer } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js';
    import { RenderPass } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js';

    // --- VARIABLES GLOBALES ---
    let socket;
    let myId = null;
    let inGame = false;
    let myCar = null;
    
    const players = {}; // Diccionario de mallas de jugadores
    const state = { 
        inputs: { steer: 0, gas: false, brake: false }, 
        cfg: { invert: false },
        mySpeed: 0
    };

    // --- SISTEMA DE LOGS ---
    const consoleBody = document.getElementById('console-body');
    function log(msg, color = 'white') {
        const d = document.createElement('div');
        d.innerHTML = `<span style="color:#666">[SYS]</span> <span style="color:${color}">${msg}</span>`;
        consoleBody.appendChild(d);
        consoleBody.scrollTop = consoleBody.scrollHeight;
        console.log(msg); // Tambi√©n a consola navegador
    }

    // --- INICIALIZACI√ìN ---
    // Esperamos a que cargue el DOM y verifiquemos librer√≠as
    window.addEventListener('load', () => {
        log("Sistema iniciado. Comprobando dependencias...", "yellow");
        
        if (typeof io === 'undefined') {
            log("ERROR CR√çTICO: Socket.IO no carg√≥. ¬øEst√°s online?", "red");
            document.getElementById('connection-status').innerText = "Error: Librer√≠a de red fall√≥.";
            document.getElementById('connection-status').style.color = "red";
            return;
        }

        log("Dependencias OK. Listo para conectar.", "#5f5");
        
        // Asignar eventos de botones (Ahora es seguro hacerlo)
        document.getElementById('btn-connect').onclick = initNetwork;
        document.getElementById('btn-create-room').onclick = requestCreateRoom;
        document.getElementById('btn-refresh').onclick = requestRoomList;
        document.getElementById('btn-join-code').onclick = () => {
            const code = document.getElementById('room-code-input').value;
            if(code) joinRoom(code);
        };
        
        // UI Men√∫
        document.getElementById('menu-btn').onclick = () => {
            const m = document.getElementById('menu-modal');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        };
        document.getElementById('chk-invert').onchange = (e) => state.cfg.invert = e.target.checked;
        document.getElementById('chk-brake').onchange = (e) => {
            document.getElementById('brake-btn').style.display = e.target.checked ? 'flex' : 'none';
        };
    });

    // --- RED Y SOCKETS ---
    function initNetwork() {
        const statusEl = document.getElementById('connection-status');
        statusEl.innerText = "Conectando...";
        statusEl.style.color = "yellow";
        document.getElementById('btn-connect').disabled = true;

        try {
            // Conexi√≥n al mismo host que sirve la p√°gina
            socket = io();

            socket.on('connect', () => {
                log(`Conectado al servidor! ID: ${socket.id}`, '#0f0');
                myId = socket.id;
                
                // Transici√≥n UI
                document.getElementById('intro-panel').style.display = 'none';
                document.getElementById('lobby-ui').style.display = 'flex';
                requestRoomList();
            });

            socket.on('connect_error', (err) => {
                log(`Error conexi√≥n: ${err.message}`, 'red');
                statusEl.innerText = "Error de conexi√≥n.";
                statusEl.style.color = "red";
                document.getElementById('btn-connect').disabled = false;
            });

            socket.on('roomList', updateRoomList);
            socket.on('roomCreated', (data) => {
                log(`Sala creada: ${data.roomId}`, '#0ff');
                startGame(data.seed);
            });
            
            socket.on('roomJoined', (data) => {
                log(`Unido a sala: ${data.roomId}`, '#0ff');
                // Actualizar info visual
                document.getElementById('disp-max').innerText = data.config.maxKmh || 500;
                document.getElementById('disp-acc').innerText = data.config.accel || 40;
                startGame(data.seed);
            });

            socket.on('error', (msg) => {
                alert("Error Servidor: " + msg);
                log("Error Servidor: " + msg, "red");
            });

            socket.on('playerLeft', (id) => {
                if (players[id]) {
                    scene.remove(players[id]);
                    delete players[id];
                    log(`Jugador ${id} desconectado`, 'orange');
                }
            });

            // --- BUCLE DE JUEGO (RECEPCI√ìN) ---
            socket.on('u', (pack) => {
                if (!inGame) return;
                
                pack.forEach(p => {
                    let mesh = players[p.id];
                    
                    // Si el coche es nuevo, crearlo
                    if (!mesh) {
                        mesh = createCarMesh(p.c);
                        scene.add(mesh);
                        players[p.id] = mesh;

                        if (p.id === myId) {
                            myCar = mesh;
                            // A√±adir faros al propio coche
                            const light = new THREE.SpotLight(0xffffff, 1000);
                            light.position.set(0, 5, 0);
                            light.target.position.set(0, 0, 20);
                            light.angle = 0.5;
                            light.penumbra = 0.5;
                            mesh.add(light);
                            mesh.add(light.target);
                        }
                    }

                    // --- INTERPOLACI√ìN Y POSICIONAMIENTO ---
                    // En este prototipo simplificado, "proyectamos" los datos abstractos (dist, lat)
                    // a coordenadas 3D simples (Z = distancia, X = lateral).
                    // En un juego completo, aqu√≠ se usar√≠a la curva para calcular X/Z reales.
                    
                    // Objetivo
                    const targetPos = new THREE.Vector3(p.l, 0.6, p.d);
                    const targetRot = p.h; // Heading en radianes

                    // Lerp (Suavizado)
                    mesh.position.lerp(targetPos, 0.3);
                    
                    // Rotaci√≥n suave (correcci√≥n para evitar giros locos de 360 a 0)
                    let rotDiff = targetRot - mesh.rotation.y;
                    while (rotDiff > Math.PI) rotDiff -= Math.PI * 2;
                    while (rotDiff < -Math.PI) rotDiff += Math.PI * 2;
                    mesh.rotation.y += rotDiff * 0.3;

                    // Guardar velocidad local si soy yo
                    if (p.id === myId) state.mySpeed = p.s;
                });

                // Actualizar C√°mara y HUD
                if (myCar) {
                    // HUD
                    document.getElementById('speed-val').innerText = Math.floor(state.mySpeed * 100);
                    
                    // C√°mara Third Person
                    const offset = new THREE.Vector3(0, 6, -15);
                    offset.applyAxisAngle(new THREE.Vector3(0, 1, 0), myCar.rotation.y);
                    const camPos = myCar.position.clone().add(offset);
                    camera.position.lerp(camPos, 0.1);
                    camera.lookAt(myCar.position.clone().add(new THREE.Vector3(0, 0, 10).applyAxisAngle(new THREE.Vector3(0, 1, 0), myCar.rotation.y)));
                }
            });

        } catch (e) {
            log("Excepci√≥n al conectar: " + e, "red");
        }
    }

    function requestRoomList() {
        if(socket) socket.emit('getRooms');
    }

    function requestCreateRoom() {
        const max = parseInt(document.getElementById('cfg-max').value);
        const acc = parseInt(document.getElementById('cfg-acc').value);
        if(socket) socket.emit('createRoom', { maxKmh: max, accel: acc });
    }

    function joinRoom(id) {
        if(socket) socket.emit('joinRoom', id);
    }
    
    // Exponer join al global para los botones onclick generados din√°micamente
    window.joinRoomGlobal = (id) => joinRoom(id);

    function updateRoomList(list) {
        const cont = document.getElementById('room-list-container');
        cont.innerHTML = '';
        if (list.length === 0) {
            cont.innerHTML = '<div style="padding:20px;text-align:center;color:#666">No hay partidas activas. ¬°Crea una!</div>';
            return;
        }
        
        list.forEach(r => {
            const div = document.createElement('div');
            div.className = 'room-item';
            div.innerHTML = `
                <div class="room-info">
                    <span class="room-code">SALA: ${r.id}</span> 
                    <span class="room-details">Pilotos: ${r.players} | Max: ${r.config.maxKmh}km/h</span>
                </div>
                <button onclick="window.joinRoomGlobal('${r.id}')">ENTRAR</button>
            `;
            cont.appendChild(div);
        });
    }

    // --- CONTROLES T√ÅCTILES Y DE TECLADO ---
    function sendInput() {
        if (!inGame || !socket) return;
        
        let steerVal = state.inputs.steer;
        if (state.cfg.invert) steerVal *= -1;
        
        // Enviar al servidor
        socket.emit('playerInput', { 
            steer: steerVal, 
            gas: state.inputs.gas, 
            brake: state.inputs.brake 
        });
    }

    // Joystick Virtual
    const joyZone = document.getElementById('joystick-zone');
    const joyKnob = document.getElementById('joystick-knob');
    let joyTouchId = null;
    const joyRect = { w: 0, x: 0 };

    function handleJoyMove(clientX) {
        let dx = clientX - (joyRect.x + joyRect.w / 2);
        // Clampar movimiento
        if (dx > 50) dx = 50; 
        if (dx < -50) dx = -50;
        
        joyKnob.style.transform = `translate(${dx - 25}px, -25px)`; // -25 por radio del knob
        
        // Normalizar de -1 a 1
        state.inputs.steer = dx / 50; 
        sendInput();
    }

    joyZone.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const t = e.changedTouches[0];
        joyTouchId = t.identifier;
        const rect = joyZone.getBoundingClientRect();
        joyRect.x = rect.left; 
        joyRect.w = rect.width;
        handleJoyMove(t.clientX);
    });

    joyZone.addEventListener('touchmove', (e) => {
        e.preventDefault();
        for (let i = 0; i < e.changedTouches.length; i++) {
            if (e.changedTouches[i].identifier === joyTouchId) {
                handleJoyMove(e.changedTouches[i].clientX);
            }
        }
    });

    joyZone.addEventListener('touchend', (e) => {
        e.preventDefault();
        joyTouchId = null;
        state.inputs.steer = 0;
        joyKnob.style.transform = 'translate(-50%, -50%)'; // Reset centro
        sendInput();
    });

    // Pedales
    const bindPedal = (elemId, inputKey) => {
        const el = document.getElementById(elemId);
        const set = (val) => { state.inputs[inputKey] = val; sendInput(); };
        
        el.addEventListener('mousedown', (e) => { e.preventDefault(); set(true); });
        el.addEventListener('mouseup', (e) => { e.preventDefault(); set(false); });
        el.addEventListener('touchstart', (e) => { e.preventDefault(); set(true); });
        el.addEventListener('touchend', (e) => { e.preventDefault(); set(false); });
    };

    bindPedal('gas-btn', 'gas');
    bindPedal('brake-btn', 'brake');

    // Teclado (Para pruebas en PC)
    window.addEventListener('keydown', (e) => {
        if(e.key === 'ArrowUp' || e.key === 'w') state.inputs.gas = true;
        if(e.key === 'ArrowDown' || e.key === 's') state.inputs.brake = true;
        if(e.key === 'ArrowLeft' || e.key === 'a') state.inputs.steer = -1;
        if(e.key === 'ArrowRight' || e.key === 'd') state.inputs.steer = 1;
        sendInput();
    });
    window.addEventListener('keyup', (e) => {
        if(e.key === 'ArrowUp' || e.key === 'w') state.inputs.gas = false;
        if(e.key === 'ArrowDown' || e.key === 's') state.inputs.brake = false;
        if(e.key === 'ArrowLeft' || e.key === 'a') state.inputs.steer = 0;
        if(e.key === 'ArrowRight' || e.key === 'd') state.inputs.steer = 0;
        sendInput();
    });

    // --- MOTOR GR√ÅFICO (THREE.JS) ---
    let scene, camera, renderer, composer;

    function startGame(seed) {
        log("Iniciando motor gr√°fico...", "#f0f");
        
        // Ocultar Lobby, mostrar Carga
        document.getElementById('lobby-ui').style.display = 'none';
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('loading').style.display = 'flex';

        // Setup Escena
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050510, 0.0025);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 8000);
        camera.position.set(0, 10, -20);

        renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.body.appendChild(renderer.domElement);

        // Post-Processing (Bloom)
        const renderPass = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.5;
        bloomPass.strength = 0.4; // Brillo de ne√≥n
        bloomPass.radius = 0.3;
        
        composer = new EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloomPass);

        // Iluminaci√≥n
        const ambient = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambient);
        
        const sun = new THREE.DirectionalLight(0xffaa00, 2);
        sun.position.set(100, 200, 100);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 2048;
        sun.shadow.mapSize.height = 2048;
        sun.shadow.camera.near = 0.5;
        sun.shadow.camera.far = 500;
        scene.add(sun);

        // Entorno
        createEnvironment(seed);

        // Retardo para quitar pantalla de carga
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            inGame = true;
            animate();
            log("Juego iniciado!", "#0f0");
        }, 1500);
    }

    function createEnvironment(seed) {
        // Suelo Infinito
        const gridGeo = new THREE.PlaneGeometry(20000, 20000);
        const gridMat = new THREE.MeshStandardMaterial({ 
            color: 0x0a0a0a, 
            roughness: 0.8,
            metalness: 0.2
        });
        const ground = new THREE.Mesh(gridGeo, gridMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Decoraci√≥n retro (Grid lines)
        const gridHelper = new THREE.GridHelper(20000, 400, 0x00ffff, 0x111111);
        gridHelper.position.y = 0.1;
        scene.add(gridHelper);

        // Sol gigante Synthwave
        const sunGeo = new THREE.SphereGeometry(800, 32, 32);
        const sunMat = new THREE.MeshBasicMaterial({ color: 0xff4400, fog: false });
        const bigSun = new THREE.Mesh(sunGeo, sunMat);
        bigSun.position.set(0, 400, 4000);
        scene.add(bigSun);
    }

    function createCarMesh(colorString) {
        const group = new THREE.Group();

        // Materiales
        const bodyMat = new THREE.MeshStandardMaterial({ roughness: 0.2, metalness: 0.6 });
        bodyMat.color.setStyle(colorString); // Socket env√≠a "hsl(x,y,z)"
        
        const glassMat = new THREE.MeshStandardMaterial({ color: 0x000000, roughness: 0.1, metalness: 0.9 });
        const neonMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });

        // Chasis (Caja simple estilo Cyberpunk)
        const chassis = new THREE.Mesh(new THREE.BoxGeometry(2, 0.8, 4.5), bodyMat);
        chassis.position.y = 0.6;
        chassis.castShadow = true;
        group.add(chassis);

        // Cabina
        const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.6, 2.5), glassMat);
        cabin.position.set(0, 1.3, -0.2);
        group.add(cabin);

        // Ne√≥n trasero (Trail)
        const trail = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.2, 0.1), neonMat);
        trail.position.set(0, 0.6, -2.26);
        group.add(trail);

        return group;
    }

    function animate() {
        if (!inGame) return;
        requestAnimationFrame(animate);
        
        // Renderizar escena
        composer.render();
    }

    // Ajuste de ventana
    window.addEventListener('resize', () => {
        if(camera && renderer) {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }
    });

</script>
</body>
</html>