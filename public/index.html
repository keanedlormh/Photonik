<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Photonik Racer</title>
    
    <!-- 1. CARGA SEGURA DE SOCKET.IO (CDN) -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- 2. MAPA DE IMPORTACIONES (Para Three.js moderno) -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <!-- 3. SISTEMA DE ERRORES VISUAL (Emergencia) -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const el = document.getElementById('fatal-error');
            if(el) {
                el.style.display = 'block';
                el.innerHTML += `<p>‚ùå <b>ERROR:</b> ${msg}<br><small>${url}:${line}</small></p>`;
            }
            return false; 
        };
        
        // Log seguro
        function sysLog(msg, color='white') {
            const consoleEl = document.getElementById('console-log');
            if(consoleEl) {
                const span = document.createElement('div');
                span.style.color = color;
                span.innerHTML = `> ${msg}`;
                consoleEl.appendChild(span);
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }
            console.log(`[SYS] ${msg}`);
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #050510; color: white; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* PANTALLA DE ERROR */
        #fatal-error { display: none; position: fixed; top: 0; left: 0; width: 100%; padding: 20px; background: rgba(100,0,0,0.9); color: white; z-index: 9999; font-family: monospace; border-bottom: 2px solid red; }

        /* CONSOLA */
        #debug-ui { position: absolute; top: 10px; left: 10px; z-index: 1000; width: 300px; pointer-events: none; }
        #console-log { height: 100px; overflow-y: auto; background: rgba(0,0,0,0.5); font-size: 10px; padding: 5px; font-family: monospace; pointer-events: auto; }

        /* UI PANTALLAS */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #screen-game { display: none; pointer-events: none; } /* El juego deja pasar eventos al canvas excepto controles */
        
        /* ESTILOS MENU */
        h1 { font-size: 40px; text-shadow: 0 0 20px #0ff; margin-bottom: 30px; letter-spacing: 5px; background: linear-gradient(to right, #fff, #0ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        button { background: #222; border: 1px solid #444; color: white; padding: 15px 30px; font-size: 16px; margin: 10px; cursor: pointer; border-radius: 5px; transition: 0.2s; text-transform: uppercase; font-weight: bold; }
        button:hover { background: #333; border-color: #fff; transform: scale(1.05); }
        button.primary { background: #0066ff; border-color: #0088ff; box-shadow: 0 0 15px #0066ff88; }
        
        .panel { background: rgba(20,20,30,0.9); padding: 30px; border-radius: 20px; border: 1px solid #444; text-align: center; max-width: 400px; width: 90%; }
        input { background: #111; border: 1px solid #555; color: white; padding: 10px; border-radius: 5px; text-align: center; width: 60%; font-size: 16px; margin-bottom: 10px; }

        /* LISTA SALAS */
        #room-list { max-height: 200px; overflow-y: auto; margin-top: 20px; border-top: 1px solid #444; }
        .room-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 5px; }
        .room-row button { padding: 5px 15px; font-size: 12px; margin: 0; }

        /* CONTROLES JUEGO */
        #hud { position: absolute; inset: 0; pointer-events: none; }
        .hud-el { pointer-events: auto; }
        
        #joystick-area { position: absolute; bottom: 50px; left: 50px; width: 150px; height: 150px; border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; }
        #joystick-dot { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: #f00; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px #f00; }
        
        #pedal-gas { position: absolute; bottom: 50px; right: 40px; width: 80px; height: 150px; background: linear-gradient(#400, #f00); border-radius: 10px; border: 2px solid #fff; display: grid; place-items: center; font-size: 30px; }
        #pedal-brake { position: absolute; bottom: 50px; right: 140px; width: 70px; height: 100px; background: #444; border-radius: 10px; border: 2px solid #888; display: grid; place-items: center; font-size: 20px; }
        
        #speed-display { position: absolute; top: 20px; right: 20px; text-align: right; font-family: monospace; }
        .big-num { font-size: 60px; font-weight: bold; color: #ff0; text-shadow: 0 0 10px #ff0; }
        
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:2000; display:none; place-items: center; color: #0ff; font-family: monospace; font-size: 20px; }
    </style>
</head>
<body>

<!-- ERROR CATCHER -->
<div id="fatal-error"></div>

<!-- CONSOLA -->
<div id="debug-ui">
    <div style="background:#222; color:#0f0; padding:2px;">SYSTEM LOG</div>
    <div id="console-log"></div>
</div>

<!-- PANTALLA 1: LOGIN -->
<div id="screen-login" class="screen" style="z-index: 10;">
    <div class="panel">
        <h1>PHOTONIK</h1>
        <p style="color:#888; margin-bottom:20px;">MULTIPLAYER RACER</p>
        <button id="btn-start" class="primary">CONECTAR A SERVIDOR</button>
        <p id="status-text" style="font-size:12px; margin-top:15px; color:yellow;">Esperando...</p>
    </div>
</div>

<!-- PANTALLA 2: LOBBY -->
<div id="screen-lobby" class="screen" style="display:none; z-index: 9;">
    <div class="panel">
        <h2>SALA DE ESPERA</h2>
        <button id="btn-create" class="primary" style="width:100%">CREAR NUEVA PARTIDA</button>
        <div style="margin: 20px 0; border-top:1px solid #555;"></div>
        
        <input type="text" id="inp-code" placeholder="C√ìDIGO SALA">
        <button id="btn-join">ENTRAR</button>
        <button id="btn-refresh">üîÑ</button>
        
        <div id="room-list">
            <div style="padding:10px; color:#666">Buscando...</div>
        </div>
    </div>
</div>

<!-- PANTALLA 3: JUEGO -->
<div id="screen-game" class="screen">
    <div id="hud">
        <div id="speed-display"><span class="big-num" id="speed-val">0</span> KM/H</div>
        
        <!-- Controles T√°ctiles -->
        <div id="joystick-area" class="hud-el"><div id="joystick-dot"></div></div>
        <div id="pedal-brake" class="hud-el">üõë</div>
        <div id="pedal-gas" class="hud-el">‚ö°</div>
    </div>
</div>

<div id="loading-overlay">CARGANDO MUNDO...</div>

<!-- L√ìGICA PRINCIPAL (MODULO) -->
<script type="module">
    import * as THREE from 'three';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';

    // --- VARIABLES GLOBALES ---
    let socket;
    let myId;
    let inGame = false;
    let gameLoopReq;
    
    // Elementos DOM
    const screens = {
        login: document.getElementById('screen-login'),
        lobby: document.getElementById('screen-lobby'),
        game: document.getElementById('screen-game')
    };
    
    // Estado Juego
    const state = {
        players: {},
        myCar: null,
        input: { steer: 0, gas: false, brake: false }
    };

    // --- 1. INICIALIZACI√ìN ---
    window.onload = () => {
        sysLog("DOM Cargado. Inicializando...");

        // Verificaci√≥n cr√≠tica
        if (typeof io === 'undefined') {
            throw new Error("La librer√≠a Socket.IO no se ha cargado. Revisa tu conexi√≥n a internet.");
        }

        // Bindings Botones
        document.getElementById('btn-start').onclick = connectToServer;
        document.getElementById('btn-create').onclick = () => socket.emit('createRoom', { maxKmh: 600 });
        document.getElementById('btn-refresh').onclick = () => socket.emit('getRooms');
        document.getElementById('btn-join').onclick = () => {
            const code = document.getElementById('inp-code').value;
            if(code) socket.emit('joinRoom', code);
        };
        
        // Exponer funci√≥n de unirse para los botones generados din√°micamente
        window.tryJoin = (id) => {
            if(socket) socket.emit('joinRoom', id);
        };

        setupControls();
    };

    // --- 2. RED (SOCKET.IO) ---
    function connectToServer() {
        const btn = document.getElementById('btn-start');
        const status = document.getElementById('status-text');
        
        btn.disabled = true;
        status.innerText = "Intentando conectar...";
        
        // Conexi√≥n
        socket = io({
            transports: ['websocket', 'polling'], // Forzar m√©todos robustos
            reconnectionAttempts: 5
        });

        socket.on('connect', () => {
            sysLog(`Conectado! ID: ${socket.id}`, '#0f0');
            myId = socket.id;
            
            // Cambio pantalla
            screens.login.style.display = 'none';
            screens.lobby.style.display = 'flex';
            socket.emit('getRooms');
        });

        socket.on('connect_error', (err) => {
            sysLog(`Error Conexi√≥n: ${err.message}`, 'red');
            status.innerText = "Fallo de conexi√≥n. Reintentando...";
            status.style.color = "red";
            btn.disabled = false;
        });

        // Eventos Sala
        socket.on('roomList', updateRoomList);
        
        socket.on('roomCreated', (data) => {
            sysLog(`Sala creada: ${data.roomId}`, '#0ff');
            startGame(data.seed);
        });
        
        socket.on('roomJoined', (data) => {
            sysLog(`Unido a sala: ${data.roomId}`, '#0ff');
            startGame(data.seed);
        });

        socket.on('errorMsg', (msg) => alert(msg));
        
        // Evento Juego
        socket.on('u', (data) => {
            if(inGame) updateGameWorld(data);
        });
        
        socket.on('playerLeft', (id) => {
            if(state.players[id]) {
                scene.remove(state.players[id].mesh);
                delete state.players[id];
            }
        });
    }

    function updateRoomList(list) {
        const container = document.getElementById('room-list');
        container.innerHTML = '';
        
        if(list.length === 0) {
            container.innerHTML = '<div style="padding:10px; color:#666">No hay partidas. ¬°Crea una!</div>';
            return;
        }

        list.forEach(r => {
            const div = document.createElement('div');
            div.className = 'room-row';
            div.innerHTML = `
                <span><b>${r.id}</b> (${r.players} Jug)</span>
                <button onclick="window.tryJoin('${r.id}')">ENTRAR</button>
            `;
            container.appendChild(div);
        });
    }

    // --- 3. MOTOR GR√ÅFICO (THREE.JS) ---
    let scene, camera, renderer, composer;

    function startGame(seed) {
        document.getElementById('loading-overlay').style.display = 'grid';
        screens.lobby.style.display = 'none';
        
        // Init ThreeJS
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.002);
        
        camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);
        
        renderer = new THREE.WebGLRenderer({ antialias: false }); // False para rendimiento
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.body.appendChild(renderer.domElement);
        
        // Post-Processing
        composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, innerHeight), 1.5, 0.4, 0.85);
        bloom.threshold = 0;
        bloom.strength = 0.6; // Neon intenso
        bloom.radius = 0.5;
        composer.addPass(bloom);

        // Environment
        buildWorld(seed);

        // Start Loop
        inGame = true;
        animate();
        
        setTimeout(() => {
            document.getElementById('loading-overlay').style.display = 'none';
            screens.game.style.display = 'block';
        }, 1000);
    }

    function buildWorld(seed) {
        // Suelo Grid
        const grid = new THREE.GridHelper(5000, 200, 0xff00ff, 0x220022);
        grid.position.y = -1;
        scene.add(grid);

        // Suelo Plano Reflectante
        const plane = new THREE.Mesh(
            new THREE.PlaneGeometry(5000, 5000),
            new THREE.MeshBasicMaterial({ color: 0x110011 })
        );
        plane.rotation.x = -Math.PI/2;
        plane.position.y = -1.1;
        scene.add(plane);
        
        // Sol Retro
        const sun = new THREE.Mesh(
            new THREE.CircleGeometry(500, 32),
            new THREE.MeshBasicMaterial({ color: 0xffaa00 })
        );
        sun.position.set(0, 200, -2000);
        scene.add(sun);
    }

    function createCar(color) {
        const g = new THREE.Group();
        
        // Cuerpo Tron
        const geo = new THREE.BoxGeometry(2, 1, 4);
        const mat = new THREE.MeshBasicMaterial({ color: 0x000000 }); // Negro base
        const mesh = new THREE.Mesh(geo, mat);
        
        // Bordes Neon
        const edges = new THREE.EdgesGeometry(geo);
        const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: color }));
        
        g.add(mesh);
        g.add(line);
        
        return g;
    }

    function updateGameWorld(serverData) {
        serverData.forEach(p => {
            let player = state.players[p.i];
            
            // Nuevo jugador
            if(!player) {
                const mesh = createCar(p.c);
                scene.add(mesh);
                state.players[p.i] = { mesh: mesh };
                player = state.players[p.i];
                
                if(p.i === myId) state.myCar = mesh;
            }

            // Interpolaci√≥n visual
            // Mapeamos Z (distancia) y X (lateral) a mundo 3D
            const targetPos = new THREE.Vector3(p.x, 0.5, -p.z); // Invertimos Z para avanzar hacia fondo
            
            player.mesh.position.lerp(targetPos, 0.3);
            player.mesh.rotation.y = -p.h; // Giro

            if(p.i === myId) {
                // Actualizar HUD
                document.getElementById('speed-val').innerText = Math.floor(p.s * 100);
                
                // C√°mara Follow
                const camOff = new THREE.Vector3(0, 8, 15); // Detr√°s y arriba
                camera.position.lerp(player.mesh.position.clone().add(camOff), 0.1);
                camera.lookAt(player.mesh.position);
            }
        });
    }

    function animate() {
        if(!inGame) return;
        requestAnimationFrame(animate);
        composer.render();
    }

    // --- 4. CONTROLES ---
    function setupControls() {
        const send = () => {
            if(socket && inGame) socket.emit('playerInput', state.input);
        };

        // Joystick T√°ctil
        const zone = document.getElementById('joystick-area');
        const knob = document.getElementById('joystick-dot');
        let jId = null; 
        const jRect = {x:0, w:0};

        const moveJoy = (cx) => {
            let dx = cx - (jRect.x + jRect.w/2);
            dx = Math.max(-75, Math.min(75, dx)); // Clamp
            knob.style.transform = `translate(${dx-25}px, -25px)`;
            state.input.steer = dx / 75; // -1 a 1
            send();
        };

        zone.addEventListener('touchstart', e => {
            e.preventDefault();
            jId = e.changedTouches[0].identifier;
            const r = zone.getBoundingClientRect();
            jRect.x = r.left; jRect.w = r.width;
            moveJoy(e.changedTouches[0].clientX);
        });
        
        zone.addEventListener('touchmove', e => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === jId) moveJoy(e.changedTouches[i].clientX);
            }
        });
        
        zone.addEventListener('touchend', e => {
            e.preventDefault();
            jId = null;
            state.input.steer = 0;
            knob.style.transform = `translate(-50%, -50%)`;
            send();
        });

        // Pedales
        const bind = (id, key) => {
            const el = document.getElementById(id);
            const down = (e) => { e.preventDefault(); state.input[key] = true; send(); };
            const up = (e) => { e.preventDefault(); state.input[key] = false; send(); };
            el.addEventListener('mousedown', down); window.addEventListener('mouseup', up);
            el.addEventListener('touchstart', down); el.addEventListener('touchend', up);
        };
        bind('pedal-gas', 'gas');
        bind('pedal-brake', 'brake');
        
        // Teclado
        window.addEventListener('keydown', e => {
            if(e.key==='ArrowUp') state.input.gas=true;
            if(e.key==='ArrowDown') state.input.brake=true;
            if(e.key==='ArrowLeft') state.input.steer=-1;
            if(e.key==='ArrowRight') state.input.steer=1;
            send();
        });
        window.addEventListener('keyup', e => {
            if(e.key==='ArrowUp') state.input.gas=false;
            if(e.key==='ArrowDown') state.input.brake=false;
            if(e.key==='ArrowLeft') state.input.steer=0;
            if(e.key==='ArrowRight') state.input.steer=0;
            send();
        });
    }
</script>
</body>
</html>